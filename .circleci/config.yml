version: 2.1

executors:
  chefdk:
    docker:
      - image: chef/chefworkstation:current
  chef:
    machine:
      image: ubuntu-2004:202107-02

jobs:
  lint:
    executor: chefdk
    environment:
      CHEF_LICENSE: accept-no-persist
    steps:
      - checkout
      - run:
          name: Run delivery
          command: delivery local lint

  unit:
    executor: chefdk
    environment:
      CHEF_LICENSE: accept-no-persist
    steps:
      - checkout
      - run:
          name: Install gems
          command: chef gem install coveralls json_spec
      - run:
          name: Run delivery
          command: delivery local unit

  integration:
    executor: chef
    parameters:
      agent_major_version:
        description: Datadog Agent version series
        type: integer
      chef_version:
        description: Chef version to test against
        type: string
      os:
        description: OS and version to test against
        type: string
    environment:
      AGENT_MAJOR_VERSION: <<parameters.agent_major_version>>
      CHEF_LICENSE: accept-no-persist
      CHEF_VERSION: <<parameters.chef_version>>
      KITCHEN_LOCAL_YAML: kitchen.dokken.yml
    steps:
      - checkout
      - run:
          name: Install Chef
          command: |
            curl -L https://omnitruck.chef.io/install.sh |
              sudo bash -s -- -c stable -P chefdk
      - run:
          name: Test Kitchen
          no_output_timeout: 1h
          command: kitchen test <<parameters.os>>
      - store_artifacts:
          path: .kitchen/logs

workflows:
  build_and_test:
    jobs:
      - lint
      - unit
      - integration:
          matrix:
            parameters:
              agent_major_version:
                - 5
                - 6
                - 7
              chef_version:
                - "12"
                - "14"
                - "16"
                - "17"
              os:
                - amazonlinux-2
                - centos-7
                - centos-8
                - debian-9
                - debian-10
                - ubuntu-1804
                - ubuntu-2004
